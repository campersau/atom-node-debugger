"use 6to5";

const h = require('virtual-dom/h');
const diff = require('virtual-dom/diff');
const patch = require('virtual-dom/patch');
const createElement = require('virtual-dom/create-element');
const DOMDelegator = require('dom-delegator');
const Rx = require('rx-dom');

const pipe = require('app/pipe');
const bind = require('app/bind');

const model = require('app/models');
const view = require('app/views');
const action = require('app/actions');

var delegator;

exports.render = function f() {
  delegator = new DOMDelegator();
  var m = model();
  var v = view();
  var c = action();
  var initTree = h('atom-panel');
  var rootNode = createElement(initTree);

  bind(m, v, c);

  v.tree$.startWith(initTree).bufferWithCount(2, 1).subscribe(
    buffer => {
      let oldVTree = buffer[0];
      let newVTree = buffer[1];
      rootNode = patch(rootNode, diff(oldVTree, newVTree));
    },
    () => console.log('end'),
    err => console.error(err.stack)
  );

  return rootNode;
};
